# name: Build and Push to Dockerhub and deploy to ec2
# on:
#   workflow_run:
#     workflows: ["Check Backend Build Succeeds"] # ðŸ‘ˆ Name of CI workflow
#     types:
#       - completed
# jobs:
#   build-push-deploy:
#     if: ${{ github.event.workflow_run.conclusion == 'success' }}
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout the repo
#         uses: actions/checkout@v4

#       - name: Log in to Docker hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       - name: Build and Push Image
#         uses: docker/build-push-action@v6
#         with:
#           context: ./server
#           file: ./server/Dockerfile
#           push: true
#           tags: vajradhardummu/punarnavah-server:latest

#       - name: Verify Docker image
#         run: docker pull vajradhardummu/punarnavah-server:latest

#       - name: Deploy to ec2
#         uses: appleboy/ssh-action@v0.1.9
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USERNAME }}
#           key: ${{ secrets.SSH_KEY }}
#           script: |
#             sudo docker pull vajradhardummu/punarnavah-server:latest
#             sudo docker stop punarnavah-server || true
#             sudo docker rm punarnavah-server || true
#             sudo docker run -d -p 8080:8080 \
#               -e NODE_ENV=production \
#               -e PORT=${{ secrets.ENV_PORT }} \
#               -e DATABASE_URL=${{ secrets.ENV_DATABASE_URL }} \
#               -e CLIENT_URL=${{ secrets.ENV_CLIENT_URL }} \
#               -e JWT_SECRET=${{ secrets.ENV_JWT_SECRET }} \
#               -e SENDER_EMAIL=${{ secrets.ENV_SENDER_EMAIL }} \
#               -e SENDER_PASS=${{ secrets.ENV_SENDER_PASS }} \
#               --name punarnavah-server vajradhardummu/punarnavah-server:latest
name: Build and Push to Dockerhub and deploy to EC2
on:
  workflow_run:
    workflows: ["Check Backend Build Succeeds"] # ðŸ‘ˆ Name of CI workflow
    types:
      - completed

jobs:
  build-push-deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          tags: vajradhardummu/punarnavah-server:latest

      - name: Verify Docker image
        run: docker pull vajradhardummu/punarnavah-server:latest

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Log in to Docker Hub
            echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            # Pull the latest Docker image from Docker Hub
            sudo docker pull vajradhardummu/punarnavah-server:latest

            # Stop and remove existing container (if exists)
            sudo docker ps -a -q --filter "name=punarnavah-server" | grep -q . && sudo docker stop punarnavah-server || true
            sudo docker ps -a -q --filter "name=punarnavah-server" | grep -q . && sudo docker rm punarnavah-server || true

            # Run the new container with environment variables
            sudo docker run -d -p 8080:8080 \
              -e NODE_ENV=production \
              -e PORT=${{ secrets.ENV_PORT }} \
              -e DATABASE_URL=${{ secrets.ENV_DATABASE_URL }} \
              -e CLIENT_URL=${{ secrets.ENV_CLIENT_URL }} \
              -e JWT_SECRET=${{ secrets.ENV_JWT_SECRET }} \
              -e SENDER_EMAIL=${{ secrets.ENV_SENDER_EMAIL }} \
              -e SENDER_PASS=${{ secrets.ENV_SENDER_PASS }} \
              --name punarnavah-server vajradhardummu/punarnavah-server:latest
